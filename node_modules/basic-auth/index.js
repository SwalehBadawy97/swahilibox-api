/*!
 * basic-auth
 * Copyright(c) 2013 TJ Holowaychuk
 * Copyright(c) 2014 Jonathan Ong
<<<<<<< HEAD
 * Copyright(c) 2015-2016 Douglas Christopher Wilson
=======
 * Copyright(c) 2015 Douglas Christopher Wilson
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
 * MIT Licensed
 */

'use strict'

/**
<<<<<<< HEAD
 * Module dependencies.
 * @private
 */

var Buffer = require('safe-buffer').Buffer

/**
=======
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
 * Module exports.
 * @public
 */

module.exports = auth
<<<<<<< HEAD
module.exports.parse = parse
=======
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4

/**
 * RegExp for basic auth credentials
 *
 * credentials = auth-scheme 1*SP token68
 * auth-scheme = "Basic" ; case insensitive
 * token68     = 1*( ALPHA / DIGIT / "-" / "." / "_" / "~" / "+" / "/" ) *"="
 * @private
 */

<<<<<<< HEAD
var CREDENTIALS_REGEXP = /^ *(?:[Bb][Aa][Ss][Ii][Cc]) +([A-Za-z0-9._~+/-]+=*) *$/
=======
var credentialsRegExp = /^ *(?:[Bb][Aa][Ss][Ii][Cc]) +([A-Za-z0-9\-\._~\+\/]+=*) *$/
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4

/**
 * RegExp for basic auth user/pass
 *
 * user-pass   = userid ":" password
 * userid      = *<TEXT excluding ":">
 * password    = *TEXT
 * @private
 */

<<<<<<< HEAD
var USER_PASS_REGEXP = /^([^:]*):(.*)$/
=======
var userPassRegExp = /^([^:]*):(.*)$/
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4

/**
 * Parse the Authorization header field of a request.
 *
 * @param {object} req
 * @return {object} with .name and .pass
 * @public
 */

<<<<<<< HEAD
function auth (req) {
=======
function auth(req) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  if (!req) {
    throw new TypeError('argument req is required')
  }

  if (typeof req !== 'object') {
    throw new TypeError('argument req is required to be an object')
  }

  // get header
<<<<<<< HEAD
  var header = getAuthorization(req)

  // parse header
  return parse(header)
=======
  var header = getAuthorization(req.req || req)

  // parse header
  var match = credentialsRegExp.exec(header || '')

  if (!match) {
    return
  }

  // decode user pass
  var userPass = userPassRegExp.exec(decodeBase64(match[1]))

  if (!userPass) {
    return
  }

  // return credentials object
  return new Credentials(userPass[1], userPass[2])
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
}

/**
 * Decode base64 string.
 * @private
 */

<<<<<<< HEAD
function decodeBase64 (str) {
  return Buffer.from(str, 'base64').toString()
=======
function decodeBase64(str) {
  return new Buffer(str, 'base64').toString()
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
}

/**
 * Get the Authorization header from request object.
 * @private
 */

<<<<<<< HEAD
function getAuthorization (req) {
=======
function getAuthorization(req) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  if (!req.headers || typeof req.headers !== 'object') {
    throw new TypeError('argument req is required to have headers property')
  }

  return req.headers.authorization
}

/**
<<<<<<< HEAD
 * Parse basic auth to object.
 *
 * @param {string} string
 * @return {object}
 * @public
 */

function parse (string) {
  if (typeof string !== 'string') {
    return undefined
  }

  // parse header
  var match = CREDENTIALS_REGEXP.exec(string)

  if (!match) {
    return undefined
  }

  // decode user pass
  var userPass = USER_PASS_REGEXP.exec(decodeBase64(match[1]))

  if (!userPass) {
    return undefined
  }

  // return credentials object
  return new Credentials(userPass[1], userPass[2])
}

/**
=======
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
 * Object to represent user credentials.
 * @private
 */

<<<<<<< HEAD
function Credentials (name, pass) {
=======
function Credentials(name, pass) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  this.name = name
  this.pass = pass
}
