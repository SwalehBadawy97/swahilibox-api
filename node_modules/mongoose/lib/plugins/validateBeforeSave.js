'use strict';

/*!
 * ignore
 */

module.exports = function(schema) {
<<<<<<< HEAD
  const unshift = true;
  schema.pre('save', false, function(next, options) {
=======
  schema.callQueue.unshift(['pre', ['save', function(next, options) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
    var _this = this;
    // Nested docs have their own presave
    if (this.ownerDocument) {
      return next();
    }

    var hasValidateBeforeSaveOption = options &&
        (typeof options === 'object') &&
        ('validateBeforeSave' in options);

    var shouldValidate;
    if (hasValidateBeforeSaveOption) {
      shouldValidate = !!options.validateBeforeSave;
    } else {
      shouldValidate = this.schema.options.validateBeforeSave;
    }

    // Validate
    if (shouldValidate) {
<<<<<<< HEAD
      this.validate(function(error) {
        return _this.schema.s.hooks.execPost('save:error', _this, [ _this], { error: error }, function(error) {
          next(error);
        });
      });
    } else {
      next();
    }
  }, null, unshift);
=======
      // HACK: use $__original_validate to avoid promises so bluebird doesn't
      // complain
      if (this.$__original_validate) {
        this.$__original_validate({__noPromise: true}, function(error) {
          return _this.schema.s.hooks.execPost('save:error', _this, [_this], { error: error }, function(error) {
            next(error);
          });
        });
      } else {
        this.validate({__noPromise: true}, function(error) {
          return _this.schema.s.hooks.execPost('save:error', _this, [ _this], { error: error }, function(error) {
            next(error);
          });
        });
      }
    } else {
      next();
    }
  }]]);
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
};
